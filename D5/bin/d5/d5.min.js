var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},d5power;!function(t){var e=function(){function e(t){this.speed=3,this._pos=new egret.Point,this._map=t}return Object.defineProperty(e.prototype,"posX",{get:function(){return this._pos.x},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"posY",{get:function(){return this._pos.y},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"$pos",{get:function(){return this._pos},enumerable:!0,configurable:!0}),e.prototype.setPos=function(t,e){t=Math.ceil(t),e=Math.ceil(e),this._pos.x=t,this._pos.y=e},e.prototype.render=function(t){},e.prototype.run=function(t){},Object.defineProperty(e.prototype,"monitor",{get:function(){return this._monitor},enumerable:!0,configurable:!0}),e.prototype.updatePos=function(e,i){void 0===e&&(e=0),void 0===i&&(i=0);var o=this._pos.x,r=this._pos.y,s=this._map.width>t.D5Game.screenWidth,n=this._map.height>t.D5Game.screenHeight;if(this.beFocus&&s&&n){var a=s?t.D5Game.screenWidth:this._map.width,h=n?t.D5Game.screenHeight:this._map.height;o=o>this._map.width-(a>>1)?o-(this._map.width-a):o,r=r>this._map.height-(h>>1)?r-(this._map.height-h):r,o=o>a>>1&&o==this._pos.x?a>>1:o,r=r>h>>1&&r==this._pos.y?h>>1:r}else{var _=this._map.getScreenPostion(o,r);o=_.x,r=_.y}null!=this._monitor&&(this._monitor.x=o+e,this._monitor.y=r+i)},e}();t.GameObject=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){}return t.getPointAngle=function(t,e){return Math.atan2(e,t)},t.R2A=function(e){return e*t.K_R2A},t.A2R=function(e){return void 0===e&&(e=0),e*t.K_A2R},t}();e.K_R2A=180/Math.PI,e.K_A2R=Math.PI/180,t.GMath=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){}return t}();t.D5Event=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){}return t}();e.RELIVE=-1,e.Stop=8,e.Run=1,e.Sing=2,e.Attack=2,e.BowAtk=3,e.Sit=4,e.Die=5,e.Pickup=6,e.BeAtk=7,e.Wait=8,t.Actions=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function e(){this._tileFormat=".jpg",this._roadW=60,this._roadH=30,this._nowStartX=-1,this._nowStartY=-1,this._nowName="",this._tempPoint=new egret.Point}return e.rebuildPool=function(t){if(e._tilePool.length>t)for(;e._tilePool.length>t;)e._tilePool.pop();else for(;e._tilePool.length<t;)e._tilePool.push(new egret.Bitmap)},e.back2pool=function(t){-1==e._tilePool.indexOf(t)&&e._tilePool.push(t)},e.getTile=function(){var t;return t=e._tilePool.length?e._tilePool.pop():new egret.Bitmap,t.texture=null,t},e.prototype.createLoop=function(t,e,i,o,r,s){void 0===r&&(r=10),void 0===s&&(s=10);var n=this;RES.getResByUrl(e,function(e){n._mapid=t,n._tileW=e.textureWidth,n._tileH=e.textureHeight,n._mapHeight=this._tileH*s,n._mapWidth=this._tileW*r,n._onReady=i,n._onReadyThis=o,n._nowStartX=-1,n._nowStartY=-1,n._loopBg=e,n.setupRoad(null)},this)},e.prototype.enter=function(e,i,o){var r=this;RES.getResByUrl(t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+e+"/mapconf.json",function(t){r.setup(parseInt(t.id),parseInt(t.mapW),parseInt(t.mapH),parseInt(t.tileX),parseInt(t.tileY),i,o)},this)},Object.defineProperty(e.prototype,"id",{get:function(){return this._mapid},enumerable:!0,configurable:!0}),e.prototype.setContainer=function(t){t!=this._dbuffer&&(null!=this._dbuffer&&(this._dbuffer.removeChildren(),this._dbuffer.parent&&this._dbuffer.parent.removeChild(this._dbuffer)),this._dbuffer=t)},e.prototype.setTileFormat=function(t){"."!=t.substr(0,1)&&(t="."+t),this._tileFormat=t},e.prototype.setup=function(e,i,o,r,s,n,a){this._mapid=e,this._mapHeight=o,this._mapWidth=i,this._tileW=r,this._tileH=s,this._onReady=n,this._onReadyThis=a,this._nowStartX=-1,this._nowStartY=-1;var h=this,_=function(e){h._smallMap=new egret.SpriteSheet(e),h.createSmallData(e.textureWidth,e.textureHeight),RES.getResByUrl(t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+this._mapid+"/roadmap.bin",this.setupRoad,this,RES.ResourceItem.TYPE_BIN)};RES.getResByUrl(t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+this._mapid+"/s.jpg",_,this)},e.prototype.createSmallData=function(t,e){var i,o,r=t/(this._mapWidth/this._tileW),s=e/(this._mapHeight/this._tileH);for(o=0;o<this._mapWidth/this._tileW;o++)for(i=0;i<this._mapHeight/this._tileH;i++)this._smallMap.createTexture("small"+o+"_"+i,i*r,o*s,r,s,0,0)},Object.defineProperty(e.prototype,"width",{get:function(){return this._mapWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._mapHeight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tileWidth",{get:function(){return this._tileW},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tileHeight",{get:function(){return this._tileH},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"roadWidth",{get:function(){return this._roadW},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"roadHeight",{get:function(){return this._roadH},enumerable:!0,configurable:!0}),e.prototype.render=function(e){void 0===e&&(e=!1),this.mod_buffer&&(this.mod_buffer=!1,this._dbuffer.cacheAsBitmap=!0);var i=parseInt(t.Camera.zeroX/this._tileW),o=parseInt(t.Camera.zeroY/this._tileH);if(this.makeData(i,o,e),this._nowStartX==i&&this._nowStartY==o&&null!=this._posFlush){var r=t.Camera.zeroX%this._tileW,s=t.Camera.zeroY%this._tileH;this._dbuffer.x=-r,this._dbuffer.y=-s}},e.prototype.resize=function(){this._areaX=Math.ceil(t.D5Game.screenWidth/this._tileW)+1,this._areaY=Math.ceil(t.D5Game.screenHeight/this._tileH)+1,console.log("[D5Game] max tiles number ",this._areaX,this._areaY),e.rebuildPool(this._areaX*this._areaY+this._areaX+this._areaY)},e.prototype.resetRoad=function(){this._roadArr=[],this._alphaArr=[];for(var t=Math.floor(this._mapHeight/this._roadH),e=Math.floor(this._mapWidth/this._roadW),i=0;t>i;i++){for(var o=new Array,r=new Array,s=0;e>s;s++)o.push(0),r.push(0);this._roadArr.push(o),this._alphaArr.push(r)}},e.prototype.setRoad=function(t){this._roadArr=t},e.prototype.isInAlphaArea=function(t,i){var o=this.Postion2Tile(t,i);return this._alphaArr[o.y]&&this._alphaArr[o.y][o.x]==e.BIN_ALPHA_VALUE},e.prototype.getPointAround=function(e,i,o){if(!e||!i)return null;for(var r=0,s=5,n=2*Math.PI/s,a=new egret.Point,h=t.GMath.getPointAngle(e.x-i.x,e.y-i.y)+(Math.random()>.5?1:-1)*Math.PI/8;s>r;){var _=n*r+h;if(a.x=Math.round(e.x-o*Math.cos(_)),a.y=Math.round(e.y-o*Math.sin(_)),this.PointCanMove(a,i))return a;r++}return null},e.prototype.PointCanMove=function(t,e){if(null==this._astar)return!0;var i=this._astar.find(e.x,e.y,t.x,t.y);return null!=i},e.prototype.getRoadPass=function(t,e){return null==this._roadArr[e]||0!=this._roadArr[e][t]?!1:!0},e.prototype.findPath=function(t,e,i,o){return null==this._astar?null:this._astar.find(t,e,i,o)},e.prototype.getWorldPostion=function(e,i){return this._tempPoint.x=t.Camera.zeroX+e,this._tempPoint.y=t.Camera.zeroY+i,this._tempPoint},e.prototype.getScreenPostion=function(e,i){return this._tempPoint.x=e-t.Camera.zeroX,this._tempPoint.y=i-t.Camera.zeroY,this._tempPoint},e.prototype.tile2WorldPostion=function(t,e){return this._tempPoint.x=t*this._roadW+.5*this._roadW,this._tempPoint.y=e*this._roadH+.5*this._roadH,this._tempPoint},e.prototype.Postion2Tile=function(t,e){return this._tempPoint.x=Math.floor(t/this._roadW),this._tempPoint.y=Math.floor(e/this._roadH),this._tempPoint},e.prototype.reset=function(){this._tempPoint=new egret.Point,this._mapResource={tiles:new Object},this._dbuffer&&this._dbuffer.removeChildren()},e.prototype.setupRoad=function(i){if(null==i||void 0==i)this.resetRoad();else{var o=new egret.ByteArray;o._setArrayBuffer(i);var r,s=o.readUTFBytes(5),n=0,a=0;if("D5Map"==s){a=o.readShort(),n=o.readShort();for(var h=[],_=0;a>_;_++){for(var p=[],l=0;n>l;l++)p.push(o.readByte());h.push(p)}if(this.resetRoad(),n>1){var u=Math.floor(this._mapHeight/this._roadH),d=Math.floor(this._mapWidth/this._roadW),f=d==n&&u==a?1:a/u;for(_=0;u>_;_++)for(l=0;d>l;l++)try{a=Math.floor(_*f),n=Math.floor(l*f),r=h[a][n],this._roadArr[_][l]=r==e.BIN_NO_VALUE?1:0,this._alphaArr[_][l]=r}catch(c){trace("［BaseMap］路点超出范围Y:X("+_+":"+l+")",a,n),this._roadArr[_][l]=e.BIN_NO_VALUE,this._alphaArr[_][l]=e.BIN_NO_VALUE}}}else console.log("[BaseMap]非法的地图配置文件")}this.reset(),this.resize(),this._astar=new t.SilzAstar(this._roadArr),null!=this._onReady&&this._onReady.apply(this._onReadyThis)},e.prototype.makeData=function(t,e,i){if(this._nowStartX!=t||this._nowStartY!=e){this._nowStartX=t,this._nowStartY=e,this._posFlush=[];for(var o=0,r=this._dbuffer.numChildren;r>o;o++)this._dbuffer.getChildAt(o).texture=null;for(var s,n=Math.min(e+this._areaY,Math.floor(this._mapHeight/this._tileH)),a=Math.min(t+this._areaX,Math.floor(this._mapWidth/this._tileW)),h=e;n>h;h++)for(var _=t;a>_;_++)s=h+"_"+_,0>_||0>h||(null==this._mapResource.tiles[s]?this._loopBg?this.fillTile(_-this._nowStartX,h-this._nowStartY,this._loopBg):(this._posFlush.push(h+"_"+_+"_"+this._nowStartX+"_"+this._nowStartY+"_"+this._mapid),this.fillSmallMap(h,_,_-this._nowStartX,h-this._nowStartY)):this.fillTile(_-this._nowStartX,h-this._nowStartY,this._mapResource.tiles[s]));null==this._loopBg&&this.loadTiles()}},e.prototype.clear=function(){this._mapResource={tiles:new Object};for(var t;this._dbuffer.numChildren;)t=this._dbuffer.removeChildAt(0),t.texture=null,e.back2pool(t);this._nowName="",this._tileFormat=".jpg"},e.prototype.loadTiles=function(e){if(void 0===e&&(e=null),null!=e){var i=this._nowName.split("_");if(parseInt(i[4])!=this._mapid)return void console.log("[BaseMap] 读取了已切换了的地图资源");var o=i[0]+"_"+i[1];null==this._mapResource.tiles[o]&&(this._mapResource.tiles[o]=e);var r=parseInt(i[1])-this._nowStartX,s=parseInt(i[0])-this._nowStartY;parseInt(i[2])==this._nowStartX&&parseInt(i[3])==this._nowStartY&&this.fillTile(r,s,e),this._nowName=""}if(0==this._posFlush.length)this._dbuffer.cacheAsBitmap=!1,this.mod_buffer=!0;else if(""==this._nowName){this._nowName=this._posFlush.pop();var i=this._nowName.split("_"),n=t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+this._mapid+"/"+i[0]+"_"+i[1]+this._tileFormat;RES.getResByUrl(n,this.loadTiles,this)}},e.prototype.fillTile=function(t,i,o){var r=this._dbuffer.getChildByName(t+"_"+i);null==r&&(r=e.getTile(),r.x=t*this._tileW,r.y=i*this._tileH,r.name=t+"_"+i,this._dbuffer.addChild(r)),r.texture=o,this._dbuffer.cacheAsBitmap=!0},e.prototype.fillSmallMap=function(t,i,o,r){if(this._smallMap){var s=this._smallMap.getTexture("small"+t+"_"+i),n=this._dbuffer.getChildByName(o+"_"+r);null==n&&(n=e.getTile(),n.x=o*this._tileW,n.y=r*this._tileH,n.fillMode=egret.BitmapFillMode.SCALE,n.name=o+"_"+r,this._dbuffer.addChild(n)),n.texture=s,n.width=this._tileW,n.height=this._tileH,this._dbuffer.cacheAsBitmap=!0}},e}();e.BIN_ALPHA_VALUE=2,e.BIN_CAN_VALUE=1,e.BIN_NO_VALUE=0,e._tilePool=new Array,t.BaseMap=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function e(t){this._zorderSpeed=600,this._moveSpeed=1,this._moveAngle=0,null==e._cameraView&&(e._cameraView=new egret.Rectangle),this._cameraCutView=new egret.Rectangle,this._map=t}return Object.defineProperty(e,"needreCut",{get:function(){return e.$needreCut},enumerable:!0,configurable:!0}),e.prototype.setZero=function(i,o){i=Math.ceil(i),o=Math.ceil(o),e.zeroX=i,e.zeroY=o;var r=this._map.width-t.D5Game.screenWidth;e.zeroX=e.zeroX<0?0:e.zeroX,this._map.width>t.D5Game.screenWidth&&(e.zeroX=e.zeroX>r?r:e.zeroX),r=this._map.height-t.D5Game.screenHeight,e.zeroY=e.zeroY<0?0:e.zeroY,this._map.height>t.D5Game.screenHeight&&(e.zeroY=e.zeroY>r?r:e.zeroY)},e.prototype.update=function(){this._focus&&this.setZero(this._focus.posX-(t.D5Game.screenWidth>>1),this._focus.posY-(t.D5Game.screenHeight>>1)),e._cameraView.x=e.zeroX,e._cameraView.y=e.zeroY,e._cameraView.width=t.D5Game.screenWidth,e._cameraView.height=t.D5Game.screenHeight},Object.defineProperty(e.prototype,"focus",{get:function(){return this._focus},set:function(t){this._focus&&(this._focus.beFocus=!1),this._focus=t,t.beFocus=!0,this.update(),this.reCut()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moveSpeed",{set:function(t){this._moveSpeed=t},enumerable:!0,configurable:!0}),Object.defineProperty(e,"cameraView",{get:function(){return e._cameraView},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cameraCutView",{get:function(){var i=e.zeroX,o=e.zeroY;return i>0&&(i-=2*this._map.tileWidth),i>0&&(o-=o-2*this._map.tileHeight),i=0>i?0:i,o=0>o?0:o,this._cameraCutView.x=i,this._cameraCutView.y=o,this._cameraCutView.width=t.D5Game.screenWidth+2*this._map.tileWidth,this._cameraCutView.height=t.D5Game.screenHeight+2*this._map.tileHeight,this._cameraCutView},enumerable:!0,configurable:!0}),e.prototype.moveNorth=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&0!=e.zeroY&&(this.focus=null,this.setZero(e.zeroX,e.zeroY-this._moveSpeed*t),this.reCut())},e.prototype.moveSourth=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&(this.focus=null,this.setZero(e.zeroX,e.zeroY+this._moveSpeed*t),this.reCut())},e.prototype.moveWest=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&0!=e.zeroX&&(this.focus=null,this.setZero(e.zeroX-this._moveSpeed*t,e.zeroY),this.reCut())},e.prototype.moveEast=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&(this.focus=null,this.setZero(e.zeroX+this._moveSpeed*t,e.zeroY),this.reCut())},e.prototype.move=function(t,i,o){void 0===o&&(o=1),this.focus=null,this.setZero(e.zeroX+this._moveSpeed*t*o,e.zeroY+this._moveSpeed*i*o),this.reCut()},e.prototype.lookAt=function(e,i){this.focus=null,this.setZero(e-(t.D5Game.screenWidth>>1),i-(t.D5Game.screenHeight>>1)),this.reCut()},e.prototype.flyTo=function(i,o,r){return void 0===r&&(r=null),null!=this._timer?void console.log("[D5Camera] Camera is moving,can not do this operation."):(this.focus=null,this._moveCallBack=r,this._moveStart=new egret.Point(e.zeroX-(t.D5Game.screenWidth>>1),e.zeroY-(t.D5Game.screenHeight>>1)),this._moveEnd=new egret.Point(i-(t.D5Game.screenWidth>>1),o-(t.D5Game.screenHeight>>1)),this._timer=new egret.Timer(50),this._timer.addEventListener(egret.TimerEvent.TIMER,this.moveCamera,this),void this._timer.start())},e.prototype.moveCamera=function(t){var e=8,i=(this._moveEnd.x-this._moveStart.x)/e,o=(this._moveEnd.y-this._moveStart.y)/e;this._moveStart.x+=i,this._moveStart.y+=o,this.setZero(this._moveStart.x,this._moveStart.y),i>-.2&&.2>i&&o>-.2&&.2>o&&(this._moveEnd=null,this._timer.stop(),this._timer.removeEventListener(egret.TimerEvent.TIMER,this.moveCamera,this),this._timer=null,this.reCut(),null!=this._moveCallBack&&this._moveCallBack())},Object.defineProperty(e.prototype,"zorderSpeed",{get:function(){return this._zorderSpeed},enumerable:!0,configurable:!0}),e.prototype.reCut=function(){},e}();e.zeroX=0,e.zeroY=0,e.RenderMaxTime=10,t.Camera=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){}return t}();e.Down=0,e.LeftDown=1,e.Left=2,e.LeftUp=3,e.Up=4,e.RightUp=5,e.Right=6,e.RightDown=7,t.Direction=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){}return t}();t.DisplayPluginData=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){this._missionList=[]}return t.prototype.getMission=function(t){-1==this._missionList.indexOf(t)&&this._missionList.push(t)},t}();t.PlayerData=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(t,e){void 0===e&&(e=null),this._cellSize=5,this.path=new egret.Sprite,this.image=new egret.Bitmap,this.imageWrapper=new egret.DisplayObjectContainer,this.isDisplayMode=!1,null!=e?(this.isDisplayMode=!0,this.imageWrapper.addChild(this.image),e.addChild(this.imageWrapper),this.imageWrapper.addChild(this.path)):this.isDisplayMode=!1,this.makeGrid(t)}return Object.defineProperty(t.prototype,"WORKMODE",{set:function(t){if(8!=t&&4!=t)throw new Error("仅支持8方向或4方向寻路")},enumerable:!0,configurable:!0}),t.prototype.find=function(t,e,i,o){if(i=Math.min(i,this._grid.numCols-1),o=Math.min(o,this._grid.numRows-1),i=Math.max(i,0),o=Math.max(o,0),!this._grid.nodeValuable(i,o))return null;if(this._grid.setEndNode(i,o),t=Math.min(t,this._grid.numCols-1),e=Math.min(e,this._grid.numRows-1),t=Math.max(t,0),e=Math.max(e,0),!this._grid.nodeValuable(t,e))return null;if(this._grid.setStartNode(t,e),this.isDisplayMode)var r=egret.getTimer();if(this.astar.findPath()){if(this._index=0,this.astar.floyd(),this._path=this.astar.floydPath,this.isDisplayMode){r=egret.getTimer()-r,console.log("[SilzAstar]",r+"ms   length:"+this.astar.path.length),console.log("[SilzAstar]",this.astar.floydPath),this.path.graphics.clear();for(var s=0;s<this.astar.floydPath.length;s++){var n=this.astar.floydPath[s];this.path.graphics.lineStyle(0,16711680),this.path.graphics.drawCircle((n.x+.5)*this._cellSize,(n.y+.5)*this._cellSize,2),this.path.graphics.lineStyle(0,16711680,.5),this.path.graphics.moveTo(t,e)}}return this._path}return this.isDisplayMode&&(this._grid.setEndNode(i-1,o-1),r=egret.getTimer()-r,console.log("[SilzAstar]",r+"ms 找不到")),null},t.prototype.makeGrid=function(e){var o=e.length,s=e[0].length;this._grid=new r(s,o);var n,a;for(a=0;o>a;a++)for(n=0;s>n;n++)this._grid.setWalkable(n,a,0==e[a][n]);4==t.WorkMode?this._grid.calculateLinks(1):this._grid.calculateLinks(),this.astar=new i(this._grid),this.isDisplayMode&&(this.drawGrid(),this.path.graphics.clear())},t.prototype.drawGrid=function(){console.log("fuck")},t.prototype.getColor=function(t){return t.walkable?t==this._grid.startNode?13421772:t==this._grid.endNode?13421772:16777215:0},t}();e.WorkMode=8,t.SilzAstar=e;var i=function(){function t(t){this._straightCost=1,this._diagCost=Math.SQRT2,this.nowversion=1,this.TwoOneTwoZero=2*Math.cos(Math.PI/3),this._grid=t,this.heuristic=this.euclidian2}return t.prototype.justMin=function(t,e){return t.f<e.f},t.prototype.findPath=function(){return this._endNode=this._grid.endNode,this.nowversion++,this._startNode=this._grid.startNode,this._open=new o(this.justMin),this._startNode.g=0,this.search()},t.prototype.floyd=function(){if(null!=this.path){this._floydPath=this.path.concat();var t=this._floydPath.length;if(t>2){var e=new n(0,0),i=new n(0,0);this.floydVector(e,this._floydPath[t-1],this._floydPath[t-2]);for(var o=this._floydPath.length-3;o>=0;o--)this.floydVector(i,this._floydPath[o+1],this._floydPath[o]),e.x==i.x&&e.y==i.y?this._floydPath.splice(o+1,1):(e.x=i.x,e.y=i.y)}for(t=this._floydPath.length,o=t-1;o>=0;o--)for(var r=0;o-2>=r;r++)if(this.floydCrossAble(this._floydPath[o],this._floydPath[r])){for(var s=o-1;s>r;s--)this._floydPath.splice(s,1);o=r,t=this._floydPath.length;break}}},t.prototype.floydCrossAble=function(t,e){for(var i=this.bresenhamNodes(new egret.Point(t.x,t.y),new egret.Point(e.x,e.y)),o=i.length-2;o>0;o--)if(!this._grid.getNode(i[o].x,i[o].y).walkable)return!1;return!0},t.prototype.bresenhamNodes=function(t,e){var i=Math.abs(e.y-t.y)>Math.abs(e.x-t.x);if(i){var o=t.x;t.x=t.y,t.y=o,o=e.x,e.x=e.y,e.y=o}var r=e.x>t.x?1:e.x<t.x?-1:0,s=(e.y>t.y?1:e.y<t.y?-1:0,(e.y-t.y)/Math.abs(e.x-t.x)),n=[],a=t.x+r,h=t.y+s;for(i?n.push(new egret.Point(t.y,t.x)):n.push(new egret.Point(t.x,t.y));a!=e.x;){var _=Math.floor(h),p=Math.ceil(h);i?n.push(new egret.Point(_,a)):n.push(new egret.Point(a,_)),_!=p&&(i?n.push(new egret.Point(p,a)):n.push(new egret.Point(a,p))),a+=r,h+=s}return i?n.push(new egret.Point(e.y,e.x)):n.push(new egret.Point(e.x,e.y)),n},t.prototype.floydVector=function(t,e,i){t.x=e.x-i.x,t.y=e.y-i.y},t.prototype.search=function(){var t=this._startNode;for(t.version=this.nowversion;t!=this._endNode;){for(var e=t.links.length,i=0;e>i;i++){var o=t.links[i].node,r=t.links[i].cost,s=t.g+r,n=this.heuristic(o),a=s+n;o.version==this.nowversion?o.f>a&&(o.f=a,o.g=s,o.h=n,o.parent=t):(o.f=a,o.g=s,o.h=n,o.parent=t,this._open.ins(o),o.version=this.nowversion)}if(1==this._open.a.length)return!1;t=this._open.pop()}return this.buildPath(),!0},t.prototype.buildPath=function(){this._path=[];var t=this._endNode;for(this._path.push(t);t!=this._startNode;)t=t.parent,this._path.unshift(t)},Object.defineProperty(t.prototype,"path",{get:function(){return this._path},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"floydPath",{get:function(){return this._floydPath},enumerable:!0,configurable:!0}),t.prototype.manhattan=function(t){return Math.abs(t.x-this._endNode.x)+Math.abs(t.y-this._endNode.y)},t.prototype.manhattan2=function(t){var e=Math.abs(t.x-this._endNode.x),i=Math.abs(t.y-this._endNode.y);return e+i+Math.abs(e-i)/1e3},t.prototype.euclidian=function(t){var e=t.x-this._endNode.x,i=t.y-this._endNode.y;return Math.sqrt(e*e+i*i)},t.prototype.chineseCheckersEuclidian2=function(t){var e=t.y/this.TwoOneTwoZero,i=t.x+t.y/2,o=i-this._endNode.x-this._endNode.y/2,r=e-this._endNode.y/this.TwoOneTwoZero;return this.sqrt(o*o+r*r)},t.prototype.sqrt=function(t){return Math.sqrt(t)},t.prototype.euclidian2=function(t){var e=t.x-this._endNode.x,i=t.y-this._endNode.y;return e*e+i*i},t.prototype.diagonal=function(t){var e=Math.abs(t.x-this._endNode.x),i=Math.abs(t.y-this._endNode.y),o=Math.min(e,i),r=e+i;return this._diagCost*o+this._straightCost*(r-2*o)},t}();t.AStar=i;var o=function(){function t(t){void 0===t&&(t=null),this.a=[],this.justMinFun=function(t,e){return this.x<this.y},this.a.push(-1),null!=t&&(this.justMinFun=t)}return t.prototype.ins=function(t){var e=this.a.length;this.a[e]=t;for(var i=e>>1;e>1&&this.justMinFun(this.a[e],this.a[i]);){var o=this.a[e];this.a[e]=this.a[i],this.a[i]=o,e=i,i=e>>1}},t.prototype.pop=function(){var t=this.a[1];this.a[1]=this.a[this.a.length-1],this.a.pop();for(var e=1,i=this.a.length,o=e<<1,r=o+1;i>o;){if(i>r)var s=this.justMinFun(this.a[r],this.a[o])?r:o;else s=o;if(!this.justMinFun(this.a[s],this.a[e]))break;var n=this.a[e];this.a[e]=this.a[s],this.a[s]=n,e=s,o=e<<1,r=o+1}return t},t}();t.BinaryHeap=o;var r=function(){function t(t,e){this._straightCost=1,this._diagCost=Math.SQRT2,this._numCols=t,this._numRows=e,this._nodes=new Array;for(var i=0;i<this._numCols;i++){this._nodes[i]=new Array;for(var o=0;o<this._numRows;o++)this._nodes[i][o]=new n(i,o)}}return t.prototype.calculateLinks=function(t){void 0===t&&(t=0),this.type=t;for(var e=0;e<this._numCols;e++)for(var i=0;i<this._numRows;i++)this.initNodeLink(this._nodes[e][i],t)},t.prototype.getType=function(){return this.type},t.prototype.initNodeLink=function(t,e){var i=Math.max(0,t.x-1),o=Math.min(this.numCols-1,t.x+1),r=Math.max(0,t.y-1),n=Math.min(this.numRows-1,t.y+1);t.links=[];for(var a=i;o>=a;a++)for(var h=r;n>=h;h++){var _=this.getNode(a,h);if(_!=t&&_.walkable){if(2!=e&&a!=t.x&&h!=t.y){var p=this.getNode(t.x,h);if(!p.walkable)continue;if(p=this.getNode(a,t.y),!p.walkable)continue}var l=this._straightCost;if(t.x!=_.x&&t.y!=_.y){if(1==e)continue;if(2==e&&(t.x-_.x)*(t.y-_.y)==1)continue;l=2==e?this._straightCost:this._diagCost}t.links.push(new s(_,l))}}},t.prototype.nodeValuable=function(t,e){return this._nodes&&this._nodes[t]&&this._nodes[t][e]?!0:!1},t.prototype.getNode=function(t,e){return this._nodes[t][e]},t.prototype.setEndNode=function(t,e){this._endNode=this._nodes[t][e]},t.prototype.setStartNode=function(t,e){this._startNode=this._nodes[t][e]},t.prototype.setWalkable=function(t,e,i){this._nodes[t][e].walkable=i},Object.defineProperty(t.prototype,"endNode",{get:function(){return this._endNode},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"numCols",{get:function(){return this._numCols},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"numRows",{get:function(){return this._numRows},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"startNode",{get:function(){return this._startNode},enumerable:!0,configurable:!0}),t}();t.Grid=r;var s=function(){function t(t,e){this.node=t,this.cost=e}return t}();t.Link=s;var n=function(){function t(t,e){this.walkable=!0,this.version=1,this.x=t,this.y=e}return t.prototype.toString=function(){return"x:"+this.x+" y:"+this.y},t}();t.SilzAstarNode=n}(d5power||(d5power={}));var d5power;!function(t){var e=function(e){function i(t){var i=e.call(this,t)||this;return i._waitAction=-1,i}return __extends(i,e),i.prototype.run=function(e){if(this._targetPoint){var i=t.GMath.getPointAngle(this._targetPoint.x-this._pos.x,this._targetPoint.y-this._pos.y),o=t.GMath.R2A(i)+90;this._faceAngle!=o&&(this.faceAngle=o);var r=!1,s=!1,n=this.speed*Math.cos(i),a=this.speed*Math.sin(i);Math.abs(this._pos.x-this._targetPoint.x)<=1&&(r=!0,n=0),Math.abs(this._pos.y-this._targetPoint.y)<=1&&(s=!0,a=0),this.setPos(this._pos.x+n,this._pos.y+a),r&&s&&(this._targetPoint=null,this.action=t.Actions.Wait)}this.updatePos()},i.prototype.move2Tile=function(e,i){e=Math.ceil(e),i=Math.ceil(i);var o=this._map.tile2WorldPostion(e,i);this._targetPoint?(this._targetPoint.x=o.x,this._targetPoint.y=o.y):this._targetPoint=new egret.Point(o.x,o.y),this.action=t.Actions.Run},i.prototype.setSkin=function(t,e,i){var o=this,r=function(r){null==r?e.apply(i,null):(o._texture=r,RES.getResByUrl(t+"tex.json",s,this))},s=function(r){null==r?e.apply(i,null):(o._texture_data=r,RES.getResByUrl(t+"ske.json",n,this))},n=function(t){null==t?e.apply(i,null):(o._data=t,o._onReady=e,o._onReady_obj=i,this.setup())};"/"!=t.substr(-1)&&(t+="/"),RES.getResByUrl(t+"tex.png",r,this)},i.prototype.setup=function(){this._factory&&this._factory.dispose(),this._monitor&&(this._monitor.parent.removeChild(this._monitor),this._monitor.dispose()),this._factory=new dragonBones.EgretFactory,this._factory.addDragonBonesData(dragonBones.DataParser.parseDragonBonesData(this._data)),this._factory.addTextureAtlas(new dragonBones.EgretTextureAtlas(this._texture,this._texture_data)),this._monitor=this._factory.buildArmatureDisplay("armatureName"),this._texture_data.scale&&(this._monitor.scaleX=this._monitor.scaleY=this._texture_data.scale),this.setPos(this._pos.x,this._pos.y),this.faceAngle=this._faceAngle,this._onReady.apply(this._onReady_obj,[this]),-1!=this._waitAction&&(this.action=this._waitAction)},Object.defineProperty(i.prototype,"action",{set:function(t){return this._monitor?(this._monitor.animation.play("action"+t),void(this._waitAction=-1)):void(this._waitAction=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"faceAngle",{set:function(t){if(this._faceAngle=t,this._monitor){var e=Math.abs(this._monitor.scaleX);-22.5>t&&(t+=360),t>=-22.5&&22.5>t||(t>=22.5&&67.5>t?this._monitor.scaleX=-1*e:t>=67.5&&112.5>t?this._monitor.scaleX=-1*e:t>=112.5&&157.5>t?this._monitor.scaleX=-1*e:t>=157.5&&202.5>t||(t>=202.5&&247.5>t?this._monitor.scaleX=e:t>=247.5&&292.5>t?this._monitor.scaleX=e:this._monitor.scaleX=e))}},enumerable:!0,configurable:!0}),i}(t.GameObject);t.BoneCharacter=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(e){function i(t){var i=e.call(this,t)||this;return i._action=0,i._dir=0,i._playFrame=0,i._lastTimer=0,i._data_renderTime=0,i._data_totalFrame=0,i._data_totalDir=0,i._offX=0,i._offY=0,i._monitor=new egret.Bitmap,i}return __extends(i,e),i.prototype.addDisplayPlugin=function(e,i,o){void 0===i&&(i=0),void 0===o&&(o=0);var r=new t.DisplayPluginData;r.offX=i,r.offY=o,r.obj=e,this._plugin_list.push(r),this._monitor.parent},i.prototype.move2Tile=function(e,i){e=Math.ceil(e),i=Math.ceil(i);var o=this._map.tile2WorldPostion(e,i);this._targetPoint?(this._targetPoint.x=o.x,this._targetPoint.y=o.y):this._targetPoint=new egret.Point(o.x,o.y),this.action=t.Actions.Run},Object.defineProperty(i.prototype,"dir",{set:function(t){t!=this._dir&&(this._dir=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"monitor",{get:function(){return this._monitor},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"action",{set:function(e){this._skin&&null!=this._skin&&e!=this._action&&(null==this._sheet?this._sheet=t.D5SpriteSheet.getInstance(this._skin+e,this):this._sheet=t.D5SpriteSheet.getInstance(this._skin+e,this))},enumerable:!0,configurable:!0}),i.prototype.setSkin=function(e){var i=e.lastIndexOf("/"),o=e.substr(i+1);e=e.substr(0,i)+"/",this._skin=e,parseInt(o)>0?this.action=parseInt(o):this.action=t.Actions.Wait},i.prototype.onSpriteSheepReady=function(t){this._data_renderTime=t.renderTime,this._data_totalFrame=t.totalFrame,this._data_totalDir=t.totalDirection},i.prototype.run=function(i){if(e.prototype.run.call(this,i),this._targetPoint){var o=t.GMath.getPointAngle(this._targetPoint.x-this._pos.x,this._targetPoint.y-this._pos.y),r=t.GMath.R2A(o)+90;this._faceAngle!=r&&(this.faceAngle=r);var s=!1,n=!1,a=this.speed*Math.cos(o),h=this.speed*Math.sin(o);Math.abs(this._pos.x-this._targetPoint.x)<=1&&(s=!0,a=0),Math.abs(this._pos.y-this._targetPoint.y)<=1&&(n=!0,h=0),this.setPos(this._pos.x+a,this._pos.y+h),s&&n&&(this._targetPoint=null,this.action=t.Actions.Wait)}this.updatePos(this._offX,this._offY)},i.prototype.render=function(t){if(this._sheet&&!(t-this._lastTimer<this._sheet.renderTime)){this._lastTimer=t;var e=this._dir;this._playFrame>=this._sheet.totalFrame&&(this._playFrame=0),this._dir<=4?(1==this._sheet.totalDirection?(e=0,this._monitor.texture=this._sheet.getTexture(e,this._playFrame)):4==this._sheet.totalDirection?((1==e||2==e||3==e)&&(e=1),this._monitor.texture=this._sheet.getTexture(e,this._playFrame)):this._monitor.texture=this._sheet.getTexture(e,this._playFrame),this._monitor.scaleX=1,this._sheet.uvList?(this._offX=this._sheet.uvList[e*this._sheet.totalFrame+this._playFrame].offX,this._offY=this._sheet.uvList[e*this._sheet.totalFrame+this._playFrame].offY):(this._offX=this._sheet.gX,this._offY=this._sheet.gY)):(1==this._sheet.totalDirection?(e=0,this._monitor.texture=this._sheet.getTexture(e,this._playFrame)):4==this._sheet.totalDirection?(e=1,this._monitor.texture=this._sheet.getTexture(e,this._playFrame)):(e=8-this._dir,this._monitor.texture=this._sheet.getTexture(e,this._playFrame)),this._monitor.scaleX=-1,this._sheet.uvList?(this._offX=-this._sheet.uvList[e*this._sheet.totalFrame+this._playFrame].offX,this._offY=this._sheet.uvList[e*this._sheet.totalFrame+this._playFrame].offY):(this._offX=-this._sheet.gX,this._offY=this._sheet.gY)),this._playFrame++}},Object.defineProperty(i.prototype,"faceAngle",{set:function(e){this._faceAngle=e,-22.5>e&&(e+=360),e>=-22.5&&22.5>e?this._dir=t.Direction.Up:e>=22.5&&67.5>e?this._dir=t.Direction.RightUp:e>=67.5&&112.5>e?this._dir=t.Direction.Right:e>=112.5&&157.5>e?this._dir=t.Direction.RightDown:e>=157.5&&202.5>e?this._dir=t.Direction.Down:e>=202.5&&247.5>e?this._dir=t.Direction.LeftDown:e>=247.5&&292.5>e?this._dir=t.Direction.Left:this._dir=t.Direction.LeftUp},enumerable:!0,configurable:!0}),i}(t.GameObject);t.FrameCharacter=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(){}return t}();e.MI=50,e.RES_SERVER="",e.ASSET_PATH="resource/",e.screenWidth=1280,e.screenHeight=800,e.timer=0,e.FPS=45,t.D5Game=e}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function e(t,i,o){this._intervalID=-1,e._that=this,this._objList=[],this._container=t,this._farLayer=new egret.DisplayObjectContainer,this._groundLayer=new egret.DisplayObjectContainer,this._lowLayer=new egret.DisplayObjectContainer,this._middleLayer=new egret.DisplayObjectContainer,this._topLayer=new egret.DisplayObjectContainer,t.addChild(this._farLayer),t.addChild(this._groundLayer),t.addChild(this._lowLayer),t.addChild(this._middleLayer),t.addChild(this._topLayer),this.map=i,this.camera=o}return e.prototype.start=function(){this._map&&this._camera&&-1==this._intervalID&&(this._intervalID=setInterval(this.run,Math.floor(1e3/t.D5Game.FPS)))},Object.defineProperty(e.prototype,"map",{set:function(t){t.setContainer(this._groundLayer),this._map=t,this.start()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"camera",{set:function(t){this._camera=t,this.start()},enumerable:!0,configurable:!0}),e.prototype.addObject=function(t){-1!=this._objList.indexOf(t)&&(this._objList.push(t),this._middleLayer.addChild(t.monitor))
},e.prototype.run=function(){for(var t,i=e._that,o=egret.getTimer(),r=i._objList.length-1;r>=0;r--)t=i._objList[r],t.run(o);for(var r=i._objList.length-1;r>=0;r--)t=i._objList[r],t.render(o);i._camera.update(),i._map.render()},e}();t.D5World=e}(d5power||(d5power={}));